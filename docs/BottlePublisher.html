<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Class: BottlePublisher
  
    &mdash; Homebrew Ruby API
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "BottlePublisher";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index (B)</a> &raquo;
    
    
    <span class="title">BottlePublisher</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Class: BottlePublisher
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">BottlePublisher</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>brew/Library/Homebrew/bottle_publisher.rb</dd>
  </dl>
  
</div>








  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(tap, changed_formulae_names, bintray_org, no_publish, warn_on_publish_failure)  &#x21d2; BottlePublisher </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A new instance of BottlePublisher.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_and_check_bottles-instance_method" title="#publish_and_check_bottles (instance method)">#<strong>publish_and_check_bottles</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_bottle_file_on_bintray-instance_method" title="#publish_bottle_file_on_bintray (instance method)">#<strong>publish_bottle_file_on_bintray</strong>(f, bintray_org, creds)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Publishes the current bottle files for a given formula to Bintray.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#publish_changed_formula_bottles-instance_method" title="#publish_changed_formula_bottles (instance method)">#<strong>publish_changed_formula_bottles</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#verify_bintray_published-instance_method" title="#verify_bintray_published (instance method)">#<strong>verify_bintray_published</strong>(formulae_names)  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Verifies that formulae have been published on Bintray by downloading a bottle file for each one.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(tap, changed_formulae_names, bintray_org, no_publish, warn_on_publish_failure)  &#x21d2; <tt><span class='object_link'><a href="" title="BottlePublisher (class)">BottlePublisher</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a new instance of BottlePublisher</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


7
8
9
10
11
12
13</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'brew/Library/Homebrew/bottle_publisher.rb', line 7</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_tap'>tap</span><span class='comma'>,</span> <span class='id identifier rubyid_changed_formulae_names'>changed_formulae_names</span><span class='comma'>,</span> <span class='id identifier rubyid_bintray_org'>bintray_org</span><span class='comma'>,</span> <span class='id identifier rubyid_no_publish'>no_publish</span><span class='comma'>,</span> <span class='id identifier rubyid_warn_on_publish_failure'>warn_on_publish_failure</span><span class='rparen'>)</span>
  <span class='ivar'>@tap</span> <span class='op'>=</span> <span class='id identifier rubyid_tap'>tap</span>
  <span class='ivar'>@changed_formulae_names</span> <span class='op'>=</span> <span class='id identifier rubyid_changed_formulae_names'>changed_formulae_names</span>
  <span class='ivar'>@no_publish</span> <span class='op'>=</span> <span class='id identifier rubyid_no_publish'>no_publish</span>
  <span class='ivar'>@bintray_org</span> <span class='op'>=</span> <span class='id identifier rubyid_bintray_org'>bintray_org</span>
  <span class='ivar'>@warn_on_publish_failure</span> <span class='op'>=</span> <span class='id identifier rubyid_warn_on_publish_failure'>warn_on_publish_failure</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="publish_and_check_bottles-instance_method">
  
    #<strong>publish_and_check_bottles</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'brew/Library/Homebrew/bottle_publisher.rb', line 15</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_and_check_bottles'>publish_and_check_bottles</span>
  <span class='comment'># Formulae with affected bottles that were published
</span>  <span class='id identifier rubyid_bintray_published_formulae'>bintray_published_formulae</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='comment'># Publish bottles on Bintray
</span>  <span class='kw'>unless</span> <span class='ivar'>@no_publish</span>
    <span class='id identifier rubyid_published'>published</span> <span class='op'>=</span> <span class='id identifier rubyid_publish_changed_formula_bottles'>publish_changed_formula_bottles</span>
    <span class='id identifier rubyid_bintray_published_formulae'>bintray_published_formulae</span><span class='period'>.</span><span class='id identifier rubyid_concat'>concat</span><span class='lparen'>(</span><span class='id identifier rubyid_published'>published</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Verify bintray publishing after all patches have been applied
</span>  <span class='id identifier rubyid_bintray_published_formulae'>bintray_published_formulae</span><span class='period'>.</span><span class='id identifier rubyid_uniq!'>uniq!</span>
  <span class='id identifier rubyid_verify_bintray_published'>verify_bintray_published</span><span class='lparen'>(</span><span class='id identifier rubyid_bintray_published_formulae'>bintray_published_formulae</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish_bottle_file_on_bintray-instance_method">
  
    #<strong>publish_bottle_file_on_bintray</strong>(f, bintray_org, creds)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Publishes the current bottle files for a given formula to Bintray</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'brew/Library/Homebrew/bottle_publisher.rb', line 52</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_bottle_file_on_bintray'>publish_bottle_file_on_bintray</span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='comma'>,</span> <span class='id identifier rubyid_bintray_org'>bintray_org</span><span class='comma'>,</span> <span class='id identifier rubyid_creds'>creds</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_repo'>repo</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Utils.html" title="Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Utils/Bottles.html" title="Utils::Bottles (class)">Bottles</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Utils/Bottles/Bintray.html" title="Utils::Bottles::Bintray (class)">Bintray</a></span></span><span class='period'>.</span><span class='id identifier rubyid_repository'><span class='object_link'><a href="Utils/Bottles/Bintray.html#repository-class_method" title="Utils::Bottles::Bintray.repository (method)">repository</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_package'>package</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Utils.html" title="Utils (module)">Utils</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Utils/Bottles.html" title="Utils::Bottles (class)">Bottles</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Utils/Bottles/Bintray.html" title="Utils::Bottles::Bintray (class)">Bintray</a></span></span><span class='period'>.</span><span class='id identifier rubyid_package'><span class='object_link'><a href="Utils/Bottles/Bintray.html#package-class_method" title="Utils::Bottles::Bintray.package (method)">package</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_name'>name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_info'>info</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="FormulaInfo.html" title="FormulaInfo (class)">FormulaInfo</a></span></span><span class='period'>.</span><span class='id identifier rubyid_lookup'><span class='object_link'><a href="FormulaInfo.html#lookup-class_method" title="FormulaInfo.lookup (method)">lookup</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed publishing bottle: failed reading formula info for </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>

  <span class='kw'>unless</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_bottle_info_any'>bottle_info_any</span>
    <span class='id identifier rubyid_opoo'>opoo</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No bottle defined in formula </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_package'>package</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>return</span> <span class='kw'>false</span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_version'>version</span> <span class='op'>=</span> <span class='id identifier rubyid_info'>info</span><span class='period'>.</span><span class='id identifier rubyid_pkg_version'>pkg_version</span>
  <span class='id identifier rubyid_ohai'>ohai</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Publishing on Bintray: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_package'>package</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_version'>version</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_curl'><span class='object_link'><a href="top-level-namespace.html#curl-instance_method" title="#curl (method)">curl</a></span></span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--write-out</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--silent</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--fail</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--user</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_creds'>creds</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_creds'>creds</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--request</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>POST</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--header</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Content-Type: application/json</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>--data</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>{&quot;publish_wait_for_secs&quot;: 0}</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>https://api.bintray.com/content/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bintray_org'>bintray_org</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_repo'>repo</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_package'>package</span><span class='embexpr_end'>}</span><span class='tstring_content'>/</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_version'>version</span><span class='embexpr_end'>}</span><span class='tstring_content'>/publish</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>true</span>
<span class='kw'>rescue</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='kw'>unless</span> <span class='ivar'>@warn_on_publish_failure</span>

  <span class='id identifier rubyid_onoe'>onoe</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="publish_changed_formula_bottles-instance_method">
  
    #<strong>publish_changed_formula_bottles</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'brew/Library/Homebrew/bottle_publisher.rb', line 30</span>

<span class='kw'>def</span> <span class='id identifier rubyid_publish_changed_formula_bottles'>publish_changed_formula_bottles</span>
  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Need to load formulae to publish them!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HOMEBREW_DISABLE_LOAD_FORMULA</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_published'>published</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_bintray_creds'>bintray_creds</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='label'>user:</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HOMEBREW_BINTRAY_USER</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='label'>key:</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HOMEBREW_BINTRAY_KEY</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_bintray_creds'>bintray_creds</span><span class='lbracket'>[</span><span class='symbol'>:user</span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_bintray_creds'>bintray_creds</span><span class='lbracket'>[</span><span class='symbol'>:key</span><span class='rbracket'>]</span>
    <span class='ivar'>@changed_formulae_names</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_name'>name</span><span class='op'>|</span>
      <span class='id identifier rubyid_f'>f</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Formula.html" title="Formula (class)">Formula</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_name'>name</span><span class='rbracket'>]</span>
      <span class='kw'>next</span> <span class='kw'>if</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_bottle_unneeded?'>bottle_unneeded?</span> <span class='op'>||</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_bottle_disabled?'>bottle_disabled?</span>

      <span class='id identifier rubyid_bintray_org'>bintray_org</span> <span class='op'>=</span> <span class='ivar'>@bintray_org</span> <span class='op'>||</span> <span class='ivar'>@tap</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_downcase'>downcase</span>
      <span class='kw'>next</span> <span class='kw'>unless</span> <span class='id identifier rubyid_publish_bottle_file_on_bintray'>publish_bottle_file_on_bintray</span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='comma'>,</span> <span class='id identifier rubyid_bintray_org'>bintray_org</span><span class='comma'>,</span> <span class='id identifier rubyid_bintray_creds'>bintray_creds</span><span class='rparen'>)</span>

      <span class='id identifier rubyid_published'>published</span> <span class='op'>&lt;&lt;</span> <span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_opoo'>opoo</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You must set HOMEBREW_BINTRAY_USER and HOMEBREW_BINTRAY_KEY to add or update bottles on Bintray!</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
  <span class='id identifier rubyid_published'>published</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="verify_bintray_published-instance_method">
  
    #<strong>verify_bintray_published</strong>(formulae_names)  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Verifies that formulae have been published on Bintray by downloading a bottle file
for each one. Blocks until the published files are available.
Raises an error if the verification fails.
This does not currently work for <code>brew pull</code>, because it may have cached the old
version of a formula.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'brew/Library/Homebrew/bottle_publisher.rb', line 82</span>

<span class='kw'>def</span> <span class='id identifier rubyid_verify_bintray_published'>verify_bintray_published</span><span class='lparen'>(</span><span class='id identifier rubyid_formulae_names'>formulae_names</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>if</span> <span class='id identifier rubyid_formulae_names'>formulae_names</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Need to load formulae to verify their publication!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>HOMEBREW_DISABLE_LOAD_FORMULA</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_ohai'>ohai</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Verifying bottles published on Bintray</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_formulae'><span class='object_link'><a href="HomebrewArgvExtension.html#formulae-instance_method" title="HomebrewArgvExtension#formulae (method)">formulae</a></span></span> <span class='op'>=</span> <span class='id identifier rubyid_formulae_names'>formulae_names</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_n'>n</span><span class='op'>|</span> <span class='const'><span class='object_link'><a href="Formula.html" title="Formula (class)">Formula</a></span></span><span class='lbracket'>[</span><span class='id identifier rubyid_n'>n</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
  <span class='id identifier rubyid_max_retries'>max_retries</span> <span class='op'>=</span> <span class='int'>300</span> <span class='comment'># shared among all bottles
</span>  <span class='id identifier rubyid_poll_retry_delay_seconds'>poll_retry_delay_seconds</span> <span class='op'>=</span> <span class='int'>2</span>

  <span class='const'><span class='object_link'><a href="top-level-namespace.html#HOMEBREW_CACHE-constant" title="HOMEBREW_CACHE (constant)">HOMEBREW_CACHE</a></span></span><span class='period'>.</span><span class='id identifier rubyid_cd'>cd</span> <span class='kw'>do</span>
    <span class='id identifier rubyid_formulae'><span class='object_link'><a href="HomebrewArgvExtension.html#formulae-instance_method" title="HomebrewArgvExtension#formulae (method)">formulae</a></span></span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_f'>f</span><span class='op'>|</span>
      <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='int'>0</span>
      <span class='id identifier rubyid_wrote_dots'>wrote_dots</span> <span class='op'>=</span> <span class='kw'>false</span>
      <span class='comment'># Choose arbitrary bottle just to get the host/port for Bintray right
</span>      <span class='id identifier rubyid_jinfo'>jinfo</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="FormulaInfo.html" title="FormulaInfo (class)">FormulaInfo</a></span></span><span class='period'>.</span><span class='id identifier rubyid_lookup'><span class='object_link'><a href="FormulaInfo.html#lookup-class_method" title="FormulaInfo.lookup (method)">lookup</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span><span class='rparen'>)</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_jinfo'>jinfo</span>
        <span class='id identifier rubyid_opoo'>opoo</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Cannot publish bottle: Failed reading info for formula </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_bottle_info'>bottle_info</span> <span class='op'>=</span> <span class='id identifier rubyid_jinfo'>jinfo</span><span class='period'>.</span><span class='id identifier rubyid_bottle_info_any'>bottle_info_any</span>
      <span class='kw'>unless</span> <span class='id identifier rubyid_bottle_info'>bottle_info</span>
        <span class='id identifier rubyid_opoo'>opoo</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>No bottle defined in formula </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='period'>.</span><span class='id identifier rubyid_full_name'>full_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='kw'>next</span>
      <span class='kw'>end</span>

      <span class='comment'># Poll for publication completion using a quick partial HEAD, to avoid spurious error messages
</span>      <span class='comment'># 401 error is normal while file is still in async publishing process
</span>      <span class='id identifier rubyid_url'>url</span> <span class='op'>=</span> <span class='const'>URI</span><span class='lparen'>(</span><span class='id identifier rubyid_bottle_info'>bottle_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>url</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Verifying bottle: </span><span class='embexpr_beg'>#{</span><span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
      <span class='id identifier rubyid_http'>http</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_host'>host</span><span class='comma'>,</span> <span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_port'>port</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_use_ssl'>use_ssl</span> <span class='op'>=</span> <span class='kw'>true</span>
      <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='int'>0</span>
      <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
          <span class='id identifier rubyid_req'>req</span> <span class='op'>=</span> <span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Head</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_url'>url</span>
          <span class='id identifier rubyid_req'>req</span><span class='period'>.</span><span class='id identifier rubyid_initialize_http_header'>initialize_http_header</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>User-Agent</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='const'><span class='object_link'><a href="top-level-namespace.html#HOMEBREW_USER_AGENT_RUBY-constant" title="HOMEBREW_USER_AGENT_RUBY (constant)">HOMEBREW_USER_AGENT_RUBY</a></span></span>
          <span class='id identifier rubyid_res'>res</span> <span class='op'>=</span> <span class='id identifier rubyid_http'>http</span><span class='period'>.</span><span class='id identifier rubyid_request'>request</span> <span class='id identifier rubyid_req'>req</span>
          <span class='kw'>break</span> <span class='kw'>if</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPSuccess</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>302</span><span class='tstring_end'>&quot;</span></span>

          <span class='kw'>unless</span> <span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span><span class='lparen'>(</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTPClientError</span><span class='rparen'>)</span>
            <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to find published </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='embexpr_end'>}</span><span class='tstring_content'> bottle at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_url'>url</span><span class='embexpr_end'>}</span><span class='tstring_content'> (</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_code'>code</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_res'>res</span><span class='period'>.</span><span class='id identifier rubyid_message'>message</span><span class='embexpr_end'>}</span><span class='tstring_content'>)!</span><span class='tstring_end'>&quot;</span></span>
          <span class='kw'>end</span>

          <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to find published </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='embexpr_end'>}</span><span class='tstring_content'> bottle at </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_url'>url</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_max_retries'>max_retries</span>

          <span class='id identifier rubyid_print'>print</span><span class='lparen'>(</span><span class='id identifier rubyid_wrote_dots'>wrote_dots</span> <span class='op'>?</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span> <span class='op'>:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Waiting on Bintray.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
          <span class='id identifier rubyid_wrote_dots'>wrote_dots</span> <span class='op'>=</span> <span class='kw'>true</span>
          <span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_poll_retry_delay_seconds'>poll_retry_delay_seconds</span>
          <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>+=</span> <span class='int'>1</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>

      <span class='comment'># Actual download and verification
</span>      <span class='comment'># We do a retry on this, too, because sometimes the external curl will fail even
</span>      <span class='comment'># when the prior HEAD has succeeded.
</span>      <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_wrote_dots'>wrote_dots</span>
      <span class='id identifier rubyid_filename'>filename</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_basename'>basename</span><span class='lparen'>(</span><span class='id identifier rubyid_url'>url</span><span class='period'>.</span><span class='id identifier rubyid_path'>path</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_curl_retry_delay_seconds'>curl_retry_delay_seconds</span> <span class='op'>=</span> <span class='int'>4</span>
      <span class='id identifier rubyid_max_curl_retries'>max_curl_retries</span> <span class='op'>=</span> <span class='int'>1</span>
      <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>=</span> <span class='int'>0</span>
      <span class='comment'># We&#39;re in the cache; make sure to force re-download
</span>      <span class='id identifier rubyid_loop'>loop</span> <span class='kw'>do</span>
        <span class='kw'>begin</span>
          <span class='id identifier rubyid_curl_download'><span class='object_link'><a href="top-level-namespace.html#curl_download-instance_method" title="#curl_download (method)">curl_download</a></span></span> <span class='id identifier rubyid_url'>url</span><span class='comma'>,</span> <span class='label'>to:</span> <span class='id identifier rubyid_filename'>filename</span>
          <span class='kw'>break</span>
        <span class='kw'>rescue</span>
          <span class='id identifier rubyid_raise'>raise</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to download </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_f'>f</span><span class='embexpr_end'>}</span><span class='tstring_content'> bottle from </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_url'>url</span><span class='embexpr_end'>}</span><span class='tstring_content'>!</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>if</span> <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>&gt;=</span> <span class='id identifier rubyid_max_curl_retries'>max_curl_retries</span>

          <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>curl download failed; retrying in </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_curl_retry_delay_seconds'>curl_retry_delay_seconds</span><span class='embexpr_end'>}</span><span class='tstring_content'> sec</span><span class='tstring_end'>&quot;</span></span>
          <span class='id identifier rubyid_sleep'>sleep</span> <span class='id identifier rubyid_curl_retry_delay_seconds'>curl_retry_delay_seconds</span>
          <span class='id identifier rubyid_curl_retry_delay_seconds'>curl_retry_delay_seconds</span> <span class='op'>*=</span> <span class='int'>2</span>
          <span class='id identifier rubyid_retry_count'>retry_count</span> <span class='op'>+=</span> <span class='int'>1</span>
        <span class='kw'>end</span>
      <span class='kw'>end</span>
      <span class='id identifier rubyid_checksum'>checksum</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Checksum.html" title="Checksum (class)">Checksum</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Checksum.html#initialize-instance_method" title="Checksum#initialize (method)">new</a></span></span><span class='lparen'>(</span><span class='symbol'>:sha256</span><span class='comma'>,</span> <span class='id identifier rubyid_bottle_info'>bottle_info</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>sha256</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='const'><span class='object_link'><a href="Pathname.html" title="Pathname (class)">Pathname</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_filename'>filename</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_verify_checksum'><span class='object_link'><a href="Pathname.html#verify_checksum-instance_method" title="Pathname#verify_checksum (method)">verify_checksum</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_checksum'>checksum</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>